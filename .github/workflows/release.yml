name: Release

# Merges product files from dev → main, tags the release, creates GitHub Release.
# Non-product files (.ai-team/, docs/, test/, etc.) never reach main.

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. 0.2.0) — must match package.json'
        required: true
        type: string
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # ── Gate: tests must pass before anything ships ──
  test:
    name: Test on dev
    runs-on: ubuntu-latest
    steps:
      - name: Checkout dev
        uses: actions/checkout@v4
        with:
          ref: dev

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - name: Run tests
        run: npm test

  # ── Release: filter dev → main, tag, publish ──
  release:
    name: Release to main
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout full repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: dev

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Tag push: extract version from tag (strip leading v)
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          PKG_VERSION=$(node -p "require('./package.json').version")
          if [ "$VERSION" != "$PKG_VERSION" ]; then
            echo "::error::Version mismatch: requested=$VERSION, package.json=$PKG_VERSION"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "✓ Version validated: $VERSION"

      - name: Build main branch content
        run: |
          # Product files to keep on main (everything else is excluded)
          KEEP_FILES=(
            "index.js"
            "package.json"
            "README.md"
            "LICENSE"
            ".gitignore"
            ".npmignore"
            ".gitattributes"
            ".github/agents/squad.agent.md"
          )
          KEEP_DIRS=(
            "templates"
          )

          # Create a staging area with only product files
          STAGING=$(mktemp -d)

          # Copy individual files
          for f in "${KEEP_FILES[@]}"; do
            if [ -f "$f" ]; then
              mkdir -p "$STAGING/$(dirname "$f")"
              cp "$f" "$STAGING/$f"
            fi
          done

          # Copy directories
          for d in "${KEEP_DIRS[@]}"; do
            if [ -d "$d" ]; then
              cp -r "$d" "$STAGING/$d"
            fi
          done

          echo "── Staged product files ──"
          find "$STAGING" -type f | sort
          echo "STAGING=$STAGING" >> $GITHUB_ENV

      - name: Commit to main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Switch to main (create if it doesn't exist)
          git checkout main 2>/dev/null || git checkout --orphan main

          # Remove everything in the working tree
          git rm -rf . > /dev/null 2>&1 || true
          rm -rf *

          # Copy staged product files into working tree
          cp -r "$STAGING"/. .

          # Stage all product files
          git add -A

          # Only commit if there are changes
          if git diff --cached --quiet; then
            echo "No changes to commit — main is already up to date"
          else
            git commit -m "release: v${{ steps.version.outputs.version }}"
          fi

          # Tag the release commit on main
          git tag -a "${{ steps.version.outputs.tag }}" -m "Release ${{ steps.version.outputs.tag }}"

      - name: Push main and tag
        run: |
          git push origin main
          git push origin "${{ steps.version.outputs.tag }}"

      - name: Get previous tag
        id: prev_tag
        run: |
          PREV=$(git tag --sort=-creatordate | grep '^v' | sed -n '2p')
          echo "prev_tag=${PREV:-}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: actions/github-script@v7
        env:
          VERSION: ${{ steps.version.outputs.version }}
          TAG: ${{ steps.version.outputs.tag }}
          PREV_TAG: ${{ steps.prev_tag.outputs.prev_tag }}
        with:
          script: |
            const tag = process.env.TAG;
            const version = process.env.VERSION;
            const prevTag = process.env.PREV_TAG;

            const body = [
              `## Install`,
              '```bash',
              `npx github:bradygaster/squad`,
              '```',
              '',
              `## Upgrade`,
              '```bash',
              `npx github:bradygaster/squad upgrade`,
              '```',
              '',
              `## Pin this version`,
              '```bash',
              `npx github:bradygaster/squad#${tag}`,
              '```',
            ].join('\n');

            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: `Squad ${tag}`,
              body: body,
              draft: false,
              prerelease: version.startsWith('0.'),
              generate_release_notes: true,
            });

  # ── Verify: confirm npx resolution works ──
  verify:
    name: Verify release
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Wait for GitHub propagation
        run: sleep 15

      - name: Verify npx resolves
        run: |
          mkdir -p /tmp/verify-release && cd /tmp/verify-release
          npx -y github:bradygaster/squad --version
          echo "✓ Release verified"
